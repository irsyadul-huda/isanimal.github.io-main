<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ular Tangga Matematika Hewan</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@700&display=swap');

        :root {
            --audio-btn-bg: rgba(255, 255, 255, 0.856);
            --audio-btn-shadow: 0 3px 8px rgba(0,0,0,0.13), 0 0 0 2px #fffbe4;
            --audio-btn-radius: 50%;
            --audio-btn-size: clamp(28px, 7vw, 46px);
            --volume-slider-orange-dark: #ffe3be;
            --volume-slider-orange-dark-light: #e29120;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: url('asset/backgrround_lp.png') no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.7s cubic-bezier(.44,.05,.54,1);
        }
        body.fadein {
            opacity: 1;
        }
        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 32px;
            margin: 10px 0;
            color: #006064;
            text-shadow: 2px 2px 0px #fff;
        }

        .game-wrapper {
            position: relative;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
        }
        .board-container {
            position: relative;
            width: 490px;
            height: 350px;
            border: 4px solid #455a64;
            background-color: #8bc34a;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(7, 70px);
            grid-template-rows: repeat(5, 70px);
        }
        .cell {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: rgba(0,0,0,0.4);
            position: relative;
            box-sizing: border-box;
            border: 0.5px solid rgba(0,0,0,0.05);
            z-index: 0;
        }
        .row-odd:nth-child(odd)    { background-color: #dce775; }
        .row-odd:nth-child(even)   { background-color: #aed581; }
        .row-even:nth-child(odd)   { background-color: #ffcc80; }
        .row-even:nth-child(even)  { background-color: #689f38; }
        .start-cell {
            background-color: #8bc34a !important;
            color: #fff !important;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .token {
            width: 28px;
            height: 28px;
            font-size: 22px;
            position: absolute;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
            transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), left 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            top: 290px; left: 10px;
            pointer-events: none;
            background: none;
            text-shadow: 1px 1px 1px #eee,0 0 2px #999;
        }
        .controls {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            justify-content: space-between;
        }
        .dice-box {
            width: 60px;
            height: 60px;
            background: #fff;
            border: 3px solid #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 4px 4px 0 #333;
            user-select: none;
            transition: all 0.1s;
        }
        .dice-box:active {
            transform: scale(0.9);
            box-shadow: 2px 2px 0 #333;
        }
        .info-panel {
            text-align: left;
            margin-left: 20px;
            flex-grow: 1;
        }
        .turn-text         { font-size: 18px; font-weight: bold; color: #555; }
        .turn-highlight    { font-weight: 900; font-size: 20px; }
        .shaking           { animation: shake 0.3s infinite; background: #fff176; }
        @keyframes shake {
            0%   { transform: rotate(0deg); }
            25%  { transform: rotate(10deg); }
            50%  { transform: rotate(-10deg); }
            75%  { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: zoomIn 0.3s ease;
            position: relative;
        }
        .quiz-animal   { font-size: 50px; display: block; margin-bottom: 10px; }
        .quiz-question { font-size: 36px; font-weight: bold; color: #333; margin: 15px 0; font-family: 'Fredoka One'; }
        .quiz-input {
            padding: 10px;
            font-size: 24px;
            width: 100px;
            text-align: center;
            border: 3px solid #ccc;
            border-radius: 10px;
            outline: none;
        }
        .quiz-input:focus { border-color: #2196F3; }
        .btn-submit {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #2e7d32;
        }
        .btn-submit:active {
            transform: translateY(2px);
            box-shadow: 0 0 0;
        }
        #error-msg {
            color: #f44336;
            font-weight: bold;
            margin-top: 10px;
            min-height: 20px;
            font-size: 14px;
        }
        .success-box {
            background: #fff;
            padding: 30px;
            border-radius: 50%;
            width: 150px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px #4CAF50;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .success-icon { font-size: 60px; margin-bottom: 10px; }
        .success-text { font-weight: bold; font-size: 20px; color: #2e7d32; }
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }
        @keyframes bounceIn {
            0%   { transform: scale(0); }
            60%  { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .top-btn-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 401;
            pointer-events: none;
        }
        .back-btn {
            background: linear-gradient(90deg, #ffe299 0%, #ffc94e 100%);
            box-shadow:
                0 2px 12px #bda13950,
                0 0.5px 0 #fffbe7 inset;
            border: none;
            border-radius: 50%;
            padding: 0;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            overflow: hidden;
            transition:
                background 0.22s cubic-bezier(.19,1,.22,1),
                box-shadow 0.18s cubic-bezier(.19,1,.22,1),
                transform 0.17s cubic-bezier(.19,1,.22,1);
            z-index: 402;
            pointer-events: auto;
            position: static;
        }
        .back-btn:hover,
        .back-btn:focus {
            background: linear-gradient(90deg, #ffe299 15%, #ffc94e 93%);
            box-shadow: 0 8px 26px #e1d0885e, 0 2px 10px #ffeda185;
            transform: scale(1.13) translateY(-2px);
        }
        .back-btn:active {
            transform: scale(0.97) translateY(1px);
            box-shadow: 0 2px 9px #cfbc6370;
        }
        .back-btn .icon-home {
            display: block;
            width: 25px;
            height: 25px;
            min-width: 25px;
            min-height: 25px;
            fill: #775204;
            filter: drop-shadow(0 1px 5px #fffde3c0);
            pointer-events: none;
            transition: fill 0.18s;
        }
        .back-btn:hover .icon-home,
        .back-btn:focus .icon-home {
            fill: #b3811e;
        }

        .mute-toggle-btn {
            width: var(--audio-btn-size);
            height: var(--audio-btn-size);
            background: var(--audio-btn-bg);
            box-shadow: var(--audio-btn-shadow);
            border-radius: var(--audio-btn-radius);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: box-shadow 0.19s, background 0.18s;
            z-index: 402;
            pointer-events: auto;
            position: static;
        }
        .mute-toggle-btn:active { background: #ffe7a857; }

        .audio-dropdown-container {
            position: absolute;
            top: 69px;
            left: 0px;
            z-index: 34000;
            user-select: none;
            pointer-events: none;
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
        }
        .audio-dropdown {
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 145px;
            background: #fffbe4f3;
            box-shadow: 0 6px 26px #cfbf70a9;
            border-radius: 17px;
            margin-top: 0px;
            margin-left: 68px;
            padding: 15px 18px 16px 20px;
            z-index: 1;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            transform: translateY(-14px) scale(0.96);
            transition: opacity 0.24s, transform 0.32s;
        }
        .audio-dropdown.show {
            pointer-events: auto;
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: opacity 0.27s, transform 0.38s cubic-bezier(.55,.38,.54,1.13);
        }
        .audio-volume-slider-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .audio-volume-min,
        .audio-volume-max {
            font-size: 0.97em;
            color: #aa8a27;
            user-select: none;
            font-family: inherit;
        }
        .audio-volume-mute-mini {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 1px;
            margin-left: 2px;
            width: 19px;
            height: 20px;
            background: none;
            border: none;
            outline: none;
            box-shadow: none;
            padding: 0 !important;
            transition: background 0.18s;
        }
        .audio-volume-mute-mini:active {
            background: #ffe7a857;
            border-radius: 12px;
        }
        .audio-volume-mute-mini svg {
            display: block;
            width: 16px;
            height: 16px;
            min-width: 16px;
            min-height: 16px;
            stroke: #FBB904;
            transition: stroke 0.16s;
        }
        .audio-volume-mute-mini.muted svg {
            stroke: #999;
        }

        .audio-volume-slider {
            accent-color: var(--volume-slider-orange-dark);
            width: 100px;
            height: 5px;
            border-radius: 6px;
            background: none;
            outline: none;
            margin: 0 6px;
        }
        .audio-volume-slider::-webkit-slider-runnable-track {
            height: 5px;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--volume-slider-orange-dark), var(--volume-slider-orange-dark-light));
        }
        .audio-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--volume-slider-orange-dark);
            border: 2px solid #fffbe4;
            box-shadow: 0 2px 6px #ce8a1c42;
            cursor: pointer;
            margin-top: -5.5px;
            transition: background 0.15s;
        }
        .audio-volume-slider:focus::-webkit-slider-thumb {
            background: #a95f08;
            outline: 2px solid var(--volume-slider-orange-dark);
        }
        .audio-volume-slider::-webkit-slider-thumb:hover,
        .audio-volume-slider:active::-webkit-slider-thumb {
            background: #a95f08;
        }
        .audio-volume-slider::-moz-range-track {
            height: 5px;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--volume-slider-orange-dark), var(--volume-slider-orange-dark-light));
        }
        .audio-volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--volume-slider-orange-dark);
            border: 2px solid #fffbe4;
            box-shadow: 0 2px 6px #ce8a1c42;
            cursor: pointer;
            transition: background 0.15s;
        }
        .audio-volume-slider:focus::-moz-range-thumb {
            background: #a95f08;
            outline: 2px solid var(--volume-slider-orange-dark);
        }
        .audio-volume-slider::-moz-range-thumb:hover,
        .audio-volume-slider:active::-moz-range-thumb {
            background: #a95f08;
        }
        .audio-volume-slider:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--volume-slider-orange-dark-light);
        }

        @media (max-width: 900px) {
            .top-btn-bar { top: 12px; left: 8px; gap: 10px; }
            .back-btn { width: 41px; height: 41px; }
            .back-btn .icon-home { width: 20px; height: 20px; min-width:20px; min-height:20px; }
        }
        @media (max-width: 600px) {
            .top-btn-bar { top: 7px; left: 2vw; gap: 7px; }
            .back-btn { width: 37px; height: 37px; }
            .back-btn .icon-home { width: 16px; height:16px; min-width:16px; min-height:16px;}
            .audio-volume-slider { width: 70px; }
            .audio-dropdown-container { top: 53px; }
        }
    </style>
</head>
<body>
    <div class="top-btn-bar">
        <a href="index.html" class="back-btn" tabindex="0" aria-label="Back to Home">
            <svg class="icon-home" viewBox="0 0 32 32">
                <path d="M17 28v-8h-2v8H8V18H4.586L16 6.586 27.414 18H24v10h-7Zm-8-12V28.001 16Zm14 12h3V17h2.414L16 4.586 3.586 17H6v11h4v-8a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v8Z"/>
            </svg>
        </a>
        <button id="muteToggleBtn" class="mute-toggle-btn" aria-label="Mute / Unmute Audio" title="Mute / Unmute">
            <svg id="icon-mute-toggle" viewBox="0 0 24 24" fill="none" stroke="#FBB904" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
                <polygon id="icon-mute-toggle-polygon" points="9 9 13 9 17 5 17 19 13 15 9 15 9 9"/>
                <line id="icon-mute-toggle-line" x1="19" y1="5" x2="19" y2="19"></line>
            </svg>
        </button>
        <div class="audio-dropdown-container" style="position:absolute;left:0;top:69px;width:350px;max-width:90vw;">
            <div id="audioDropdown" class="audio-dropdown">
                <div class="audio-volume-slider-wrap">
                    <button class="audio-volume-mute-mini" id="audioMuteMiniBtn" type="button" aria-label="Mute/Unmute (Mini)">
                        <svg id="audioMuteMiniIcon" viewBox="0 0 24 24" fill="none" stroke="#FBB904" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon id="audioMuteMiniPoly" points="9 9 13 9 17 5 17 19 13 15 9 15 9 9"/>
                            <line id="audioMuteMiniLine" x1="19" y1="5" x2="19" y2="19"></line>
                        </svg>
                    </button>
                    <span class="audio-volume-min">0</span>
                    <input type="range" min="0" max="100" value="100" class="audio-volume-slider" id="audioVolumeSlider" aria-label="Volume" />
                    <span class="audio-volume-max">100</span>
                </div>
            </div>
        </div>
    </div>

    <h1>ULAR TANGGA MATEMATIKA</h1>

    <div class="game-wrapper">
        <div class="board-container">
            <div id="p0" class="token" style="padding:0;">
                <img src="https://img.icons8.com/?size=100&id=7uJob2d9mFBS&format=png&color=000000" alt="Harimau" style="width:28px;height:28px;display:block;" draggable="false" />
            </div>
            <div id="p1" class="token" style="font-size:25px;">
                <img src="https://img.icons8.com/?size=100&id=gtx2QwlbvAak&format=png&color=000000" alt="Rubah" style="width:28px;height:28px;display:block;" draggable="false" />
            </div>
            <div id="p2" class="token" style="font-size:20px;">
                <img src="https://img.icons8.com/?size=100&id=VbxKFvBFUSfq&format=png&color=000000" alt="Beruang" style="width:28px;height:28px;display:block;" draggable="false" />
            </div>
            <div id="p3" class="token" style="font-size:20px;">
                <img src="https://img.icons8.com/?size=100&id=uEwiPVltqhdZ&format=png&color=000000" alt="Jerapah" style="width:28px;height:28px;display:block;" draggable="false" />
            </div>
            <div class="board" id="board"></div>
            <svg class="overlay" width="490" height="350">
                <line x1="385" y1="315" x2="315" y2="245" stroke="#795548" stroke-width="14" stroke-linecap="round" />
                <line x1="385" y1="315" x2="315" y2="245" stroke="#fff" stroke-width="14" stroke-dasharray="5,8" opacity="0.6"/>
                <line x1="35" y1="175" x2="35" y2="105" stroke="#795548" stroke-width="14" stroke-linecap="round" />
                <line x1="35" y1="175" x2="35" y2="105" stroke="#fff" stroke-width="14" stroke-dasharray="5,8" opacity="0.6"/>
                <line x1="455" y1="175" x2="455" y2="105" stroke="#795548" stroke-width="14" stroke-linecap="round" />
                <line x1="455" y1="175" x2="455" y2="105" stroke="#fff" stroke-width="14" stroke-dasharray="5,8" opacity="0.6"/>
                <path d="M 385 35 Q 350 100 315 175" stroke="#2e7d32" stroke-width="10" fill="none" stroke-linecap="round" stroke-opacity="0.8"/>
                <circle cx="385" cy="35" r="8" fill="#1b5e20" />
                <path d="M 245 175 Q 280 210 245 245" stroke="#e64a19" stroke-width="10" fill="none" stroke-linecap="round" stroke-opacity="0.8"/>
                <circle cx="245" cy="175" r="8" fill="#bf360c" />
                <path d="M 105 105 Q 70 140 105 175" stroke="#333" stroke-width="10" fill="none" stroke-linecap="round" stroke-opacity="0.8"/>
                <circle cx="105" cy="105" r="8" fill="#000" />
            </svg>
        </div>
        <div class="controls">
            <div class="dice-box" id="diceBtn" onclick="rollDice()">ðŸŽ²</div>
            <div class="info-panel">
                <div class="turn-text">Giliran: 
                    <span id="current-player-name" class="turn-highlight" style="color:#FF5722">
                        <img src="https://img.icons8.com/?size=100&id=7uJob2d9mFBS&format=png&color=000000" alt="Harimau" style="width:22px;vertical-align:middle;margin-right:4px;">
                        Harimau
                    </span>
                </div>
                <div style="font-size:14px;color:#666;margin-top:4px;">Klik dadu untuk jalan!</div>
            </div>
            <button onclick="resetGame()" style="background:#ff5252;color:white;border:none;padding:8px 15px;border-radius:5px;font-weight:bold;cursor:pointer;">RESET</button>
        </div>
    </div>

    <audio id="backgroundAudio" src="audio.mp3" loop></audio>

    <div id="quizModal" class="modal-overlay">
        <div class="modal-box">
            <span id="quizIcon" class="quiz-animal">
                <img src="https://img.icons8.com/?size=100&id=7uJob2d9mFBS&format=png&color=000000" alt="Harimau" style="width:38px;height:38px;vertical-align:middle;" id="quizIconTiger">
            </span>
            <h3>Jawab untuk lanjut!</h3>
            <div id="quizQuestion" class="quiz-question">5 + 5 = ?</div>
            <input type="number" id="quizAnswer" class="quiz-input" placeholder="?">
            <div id="error-msg"></div>
            <button class="btn-submit" onclick="checkAnswer()">JAWAB</button>
        </div>
    </div>

    <div id="successModal" class="modal-overlay" style="background:rgba(255,255,255,0.5);">
        <div class="success-box">
            <div class="success-icon">âœ¨</div>
            <div class="success-text">HEBAT!</div>
        </div>
    </div>

    <audio id="bgMusic" loop style="display:none">
        <source src="audio.mp3" type="audio/mpeg">
        Browser Anda tidak mendukung elemen audio.
    </audio>

    <script>
        const board = document.getElementById('board');
        const diceBtn = document.getElementById('diceBtn');
        const nameLabel = document.getElementById('current-player-name');
        const quizModal = document.getElementById('quizModal');
        const successModal = document.getElementById('successModal');
        const quizQuestionEl = document.getElementById('quizQuestion');
        const quizInput = document.getElementById('quizAnswer');
        const errorMsg = document.getElementById('error-msg');
        const quizIcon = document.getElementById('quizIcon');

        const tigerIconUrl   = "https://img.icons8.com/?size=100&id=7uJob2d9mFBS&format=png&color=000000";
        const giraffeIconUrl = "https://img.icons8.com/?size=100&id=gtx2QwlbvAak&format=png&color=000000";
        const bearIconUrl    = "https://img.icons8.com/?size=100&id=VbxKFvBFUSfq&format=png&color=000000";
        const jerapahIconUrl = "https://img.icons8.com/?size=100&id=uEwiPVltqhdZ&format=png&color=000000";

        const players = [
            { id: 0, name: "Harimau", icon: "custom-tiger",   color: "#FF5722", pos: 1 },
            { id: 1, name: "Rubah",   icon: "custom-giraffe", color: "#4CAF50", pos: 1 },
            { id: 2, name: "Beruang", icon: "custom-bear",    color: "#795548", pos: 1 },
            { id: 3, name: "Jerapah", icon: "custom-jerapah", color: "#000000", pos: 1 }
        ];

        let turnIndex = 0;
        let isMoving = false;
        let correctAnswer = 0;

        const shortcuts = {
            6:  { dest: 10, type: 'ladder' },
            15: { dest: 28, type: 'ladder' },
            21: { dest: 22, type: 'ladder' },
            34: { dest: 19, type: 'snake' },
            18: { dest: 11, type: 'snake' },
            27: { dest: 16, type: 'snake' }
        };

        function initBoard() {
            board.innerHTML = "";
            const rows = [
                [29,30,31,32,33,34,35],
                [28,27,26,25,24,23,22],
                [15,16,17,18,19,20,21],
                [14,13,12,11,10,9,8],
                [1,2,3,4,5,6,7]
            ];
            let rowIdx = 5;
            rows.forEach(rowNums => {
                rowNums.forEach(num => {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.classList.add(rowIdx % 2 === 0 ? 'row-even' : 'row-odd');
                    cell.id = `cell-${num}`;
                    if (num === 1) cell.classList.add('start-cell');
                    cell.innerText = num === 1 ? "START" : num;
                    board.appendChild(cell);
                });
                rowIdx--;
            });
            updateAllPlayerPositions();
        }

        function updateAllPlayerPositions() {
            players.forEach(function(p) {
                const tokenDiv = document.getElementById("p" + p.id);
                if(tokenDiv){
                    if(p.id === 0) {
                        tokenDiv.innerHTML = `<img src="${tigerIconUrl}" alt="Harimau" style="width:28px;height:28px;display:block;" draggable="false" />`;
                    } else if(p.id === 1) {
                        tokenDiv.innerHTML = `<img src="${giraffeIconUrl}" alt="Rubah" style="width:28px;height:28px;display:block;" draggable="false" />`;
                    } else if(p.id === 2) {
                        tokenDiv.innerHTML = `<img src="${bearIconUrl}" alt="Beruang" style="width:28px;height:28px;display:block;" draggable="false" />`;
                    } else if(p.id === 3) {
                        tokenDiv.innerHTML = `<img src="${jerapahIconUrl}" alt="Jerapah" style="width:28px;height:28px;display:block;" draggable="false" />`;
                    }
                }
                moveTokenVisual(p.id, p.pos, false);
            });
        }

        function moveTokenVisual(playerId, cellNum, animate = true) {
            const token = document.getElementById(`p${playerId}`);
            const targetCell = document.getElementById(`cell-${cellNum}`);
            if (!targetCell || !token) return;

            let left = targetCell.offsetLeft;
            let top = targetCell.offsetTop;
            if (playerId === 0) { left += 5;  top += 5; }
            if (playerId === 1) { left += 35; top += 5; }
            if (playerId === 2) { left += 5;  top += 35; }
            if (playerId === 3) { left += 35; top += 35; }

            if (!animate) token.style.transition = 'none';
            else token.style.transition = 'top 0.4s ease-out, left 0.4s ease-out';

            token.style.left = `${left}px`;
            token.style.top  = `${top}px`;
        }

        async function rollDice() {
            if (isMoving) return;
            isMoving = true;
            const player = players[turnIndex];

            diceBtn.classList.add('shaking');
            diceBtn.innerText = "ðŸŽ²";
            await new Promise(r => setTimeout(r, 600));
            
            const diceVal = Math.floor(Math.random() * 6) + 1;
            diceBtn.classList.remove('shaking');
            diceBtn.innerText = diceVal;

            let nextPos = player.pos + diceVal;
            if (nextPos > 35) {
                alert("Kelebihan langkah! Tunggu giliran depan.");
                nextTurn();
                return;
            }

            for (let i = player.pos + 1; i <= nextPos; i++) {
                player.pos = i;
                moveTokenVisual(turnIndex, i, true);
                await new Promise(r => setTimeout(r, 400));
            }

            if (shortcuts[player.pos]) {
                await new Promise(r => setTimeout(r, 300));
                player.pos = shortcuts[player.pos].dest;
                moveTokenVisual(turnIndex, player.pos, true);
            }

            if (player.pos === 35) {
                setTimeout(() => alert(`SELAMAT! ${player.name} MENANG! ðŸŽ‰`), 500);
                return;
            }

            setTimeout(showMathQuiz, 500);
        }

        function generateQuestion() {
            const ops = ['+', '-', 'x', ':'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a, b;

            if (op === '+') {
                a = Math.floor(Math.random() * 20) + 1;
                b = Math.floor(Math.random() * 20) + 1;
                correctAnswer = a + b;
            } else if (op === '-') {
                a = Math.floor(Math.random() * 20) + 5;
                b = Math.floor(Math.random() * a);
                correctAnswer = a - b;
            } else if (op === 'x') {
                a = Math.floor(Math.random() * 10) + 1;
                b = Math.floor(Math.random() * 10) + 1;
                correctAnswer = a * b;
            } else if (op === ':') {
                let res = Math.floor(Math.random() * 10) + 1;
                let div = Math.floor(Math.random() * 10) + 1;
                a = res * div;
                b = div;
                correctAnswer = res;
            }

            return `${a} ${op} ${b} = ?`;
        }

        function showMathQuiz() {
            const player = players[turnIndex];
            if (player.id === 0) {
                quizIcon.innerHTML = `<img src="${tigerIconUrl}" alt="Harimau" style="width:38px;height:38px;vertical-align:middle;">`;
            } else if (player.id === 1) {
                quizIcon.innerHTML = `<img src="${giraffeIconUrl}" alt="Rubah" style="width:38px;height:38px;vertical-align:middle;">`;
            } else if (player.id === 2) {
                quizIcon.innerHTML = `<img src="${bearIconUrl}" alt="Beruang" style="width:38px;height:38px;vertical-align:middle;">`;
            } else if (player.id === 3) {
                quizIcon.innerHTML = `<img src="${jerapahIconUrl}" alt="Jerapah" style="width:38px;height:38px;vertical-align:middle;">`;
            }
            quizQuestionEl.innerText = generateQuestion();
            quizInput.value = "";
            errorMsg.innerText = "";
            quizModal.style.display = "flex";
            quizInput.focus();
        }

        function checkAnswer() {
            const userAns = parseInt(quizInput.value);
            if (userAns === correctAnswer) {
                quizModal.style.display = "none";
                successModal.style.display = "flex";
                setTimeout(() => {
                    successModal.style.display = "none";
                    nextTurn();
                }, 1500);
            } else {
                errorMsg.innerText = "Salah! Coba hitung lagi ya..";
                quizInput.value = "";
                quizInput.focus();
            }
        }

        function nextTurn() {
            turnIndex++;
            if (turnIndex >= players.length) turnIndex = 0;
            const nextP = players[turnIndex];
            if (nextP.id === 0) {
                nameLabel.innerHTML = `<img src="${tigerIconUrl}" alt="Harimau" style="width:22px;vertical-align:middle;margin-right:4px;">${nextP.name}`;
            } else if (nextP.id === 1) {
                nameLabel.innerHTML = `<img src="${giraffeIconUrl}" alt="Rubah" style="width:22px;vertical-align:middle;margin-right:4px;">${nextP.name}`;
            } else if (nextP.id === 2) {
                nameLabel.innerHTML = `<img src="${bearIconUrl}" alt="Beruang" style="width:22px;vertical-align:middle;margin-right:4px;">${nextP.name}`;
            } else if (nextP.id === 3) {
                nameLabel.innerHTML = `<img src="${jerapahIconUrl}" alt="Jerapah" style="width:22px;vertical-align:middle;margin-right:4px;">${nextP.name}`;
            }
            nameLabel.style.color = nextP.color;
            diceBtn.innerText = "ðŸŽ²";
            isMoving = false;
        }

        function resetGame() {
            players.forEach(p => p.pos = 1);
            updateAllPlayerPositions();
            turnIndex = 0;
            nameLabel.innerHTML = `<img src="${tigerIconUrl}" alt="Harimau" style="width:22px;vertical-align:middle;margin-right:4px;">Harimau`;
            nameLabel.style.color = "#FF5722";
            isMoving = false;
            diceBtn.innerText = "ðŸŽ²";
            quizModal.style.display = "none";
        }

        quizInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                checkAnswer();
            }
        });

        initBoard();

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                document.body.classList.add('fadein');
            }, 20);

            var audio = document.getElementById('backgroundAudio');
            var muteBtn = document.getElementById('muteToggleBtn');
            var iconMain = document.getElementById('icon-mute-toggle');
            var iconPolygonMain = document.getElementById('icon-mute-toggle-polygon');
            var iconLineMain = document.getElementById('icon-mute-toggle-line');
            var audioDropdown = document.getElementById('audioDropdown');
            var audioVolumeSlider = document.getElementById('audioVolumeSlider');
            var audioMuteMiniBtn = document.getElementById('audioMuteMiniBtn');
            var audioMuteMiniIcon = document.getElementById('audioMuteMiniIcon');
            var audioMuteMiniPoly = document.getElementById('audioMuteMiniPoly');
            var audioMuteMiniLine = document.getElementById('audioMuteMiniLine');

            var LS_MUTED = 'mtkgame-audio-muted';
            var LS_VOLUME = 'mtkgame-audio-volume';

            var savedAudioState = localStorage.getItem(LS_MUTED);
            var savedAudioVolume = localStorage.getItem(LS_VOLUME);

            function setMuteIcon(isMuted, svgElem, polyElem, lineElem) {
                if (!svgElem || !polyElem || !lineElem) return;
                if (isMuted) {
                    polyElem.setAttribute("points", "9 9 13 9 17 5 17 19 13 15 9 15 9 9 9 9");
                    lineElem.setAttribute("x1", "1");
                    lineElem.setAttribute("y1", "1");
                    lineElem.setAttribute("x2", "23");
                    lineElem.setAttribute("y2", "23");
                    svgElem.setAttribute("stroke", "#999");
                } else {
                    polyElem.setAttribute("points", "9 9 13 9 17 5 17 19 13 15 9 15 9 9");
                    lineElem.setAttribute("x1", "19");
                    lineElem.setAttribute("y1", "5");
                    lineElem.setAttribute("x2", "19");
                    lineElem.setAttribute("y2", "19");
                    svgElem.setAttribute("stroke", "#FBB904");
                }
            }

            if (savedAudioState === "true") {
                audio.muted = true;
            } else {
                audio.muted = false;
            }
            if (savedAudioVolume) {
                var v = parseFloat(savedAudioVolume);
                if (!isNaN(v)) {
                    audio.volume = v / 100;
                    audioVolumeSlider.value = Math.round(v);
                }
            } else {
                audio.volume = 1;
                audioVolumeSlider.value = 100;
            }

            function renderAudioIcons() {
                setMuteIcon(audio.muted, iconMain, iconPolygonMain, iconLineMain);
                setMuteIcon(audio.muted, audioMuteMiniIcon, audioMuteMiniPoly, audioMuteMiniLine);
                if (audioMuteMiniBtn) {
                    if (audio.muted) audioMuteMiniBtn.classList.add('muted');
                    else audioMuteMiniBtn.classList.remove('muted');
                }
            }
            renderAudioIcons();

            function playAudioAlways() {
                if (!audio.muted) {
                    audio.play().then(function () { })
                        .catch(function () { });
                }
            }
            setInterval(playAudioAlways, 2000);
            window.addEventListener("pointerdown", playAudioAlways, { once: true, passive: true });
            window.addEventListener("keydown", playAudioAlways, { once: true, passive: true });
            setTimeout(playAudioAlways, 200);

            let dropdownOpen = false;
            function showDropdown() {
                dropdownOpen = true;
                audioDropdown.classList.add('show');
                setTimeout(() => {
                    audioDropdown.style.pointerEvents = "auto";
                }, 40);
                document.body.addEventListener('mousedown', closeDropdownOnBody, true);
                document.body.addEventListener('touchstart', closeDropdownOnBody, true);
            }
            function hideDropdown() {
                dropdownOpen = false;
                audioDropdown.classList.remove('show');
                audioDropdown.style.pointerEvents = "none";
                setTimeout(() => {
                    document.body.removeEventListener('mousedown', closeDropdownOnBody, true);
                    document.body.removeEventListener('touchstart', closeDropdownOnBody, true);
                }, 300);
            }
            let closeDropdownOnBody = function (e) {
                if (!dropdownOpen) return;
                let t = e.target;
                if (!muteBtn.contains(t) && !audioDropdown.contains(t)) {
                    hideDropdown();
                }
            };

            muteBtn.addEventListener('click', function (evt) {
                evt.preventDefault();
                evt.stopPropagation();
                if (dropdownOpen) {
                    hideDropdown();
                } else {
                    showDropdown();
                }
            });

            if (audioMuteMiniBtn) {
                audioMuteMiniBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    audio.muted = !audio.muted;
                    if (audio.muted) {
                        localStorage.setItem(LS_MUTED, "true");
                        audio.pause();
                    } else {
                        localStorage.setItem(LS_MUTED, "false");
                        playAudioAlways();
                    }
                    renderAudioIcons();
                });
            }

            audioVolumeSlider.addEventListener('input', function () {
                let val = Number(audioVolumeSlider.value);
                let v = isNaN(val) ? 1 : Math.max(0, Math.min(val, 100));
                audio.volume = v / 100;
                localStorage.setItem(LS_VOLUME, String(v));
                if (v === 0) {
                    audio.muted = true;
                    localStorage.setItem(LS_MUTED, "true");
                    audio.pause();
                } else {
                    if (audio.muted) {
                        audio.muted = false;
                        localStorage.setItem(LS_MUTED, "false");
                        playAudioAlways();
                    }
                }
                renderAudioIcons();
            });

            audio.addEventListener('volumechange', function () {
                let volumePct = Math.round(audio.volume * 100);
                if (Number(audioVolumeSlider.value) !== volumePct) {
                    audioVolumeSlider.value = volumePct;
                }
                renderAudioIcons();
            });

            document.addEventListener('keydown', function (ev) {
                if (dropdownOpen && ev.key === "Escape") hideDropdown();
            });
            window.addEventListener('resize', function () {
                if (dropdownOpen) hideDropdown();
            });

            document.querySelector('.back-btn').addEventListener('click', function(e) {
                e.preventDefault();
                document.body.classList.remove('fadein');
                setTimeout(function() {
                    window.location.href = "index.html";
                }, 510);
            });
        });
    </script>
</body>
</html>